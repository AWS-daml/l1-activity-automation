name: L1 Activity Automation CI/CD

on:
  push:
    branches: [ master ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: production
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Deploy to EC2
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ec2-user
        key: ${{ secrets.EC2_SSH_KEY }}
        port: 22
        script: |
          set -e
          echo "ðŸš€ Starting L1 Activity Automation Deployment..."
          
          # Update system
          sudo yum update -y
          
          # Install required packages
          sudo yum install -y nodejs npm python3 python3-pip git nginx
          
          # Install PM2 globally
          sudo npm install -g pm2
          
          # Clone or update repository
          if [ ! -d "/home/ec2-user/l1-activity-automation" ]; then
            echo "ðŸ“¦ Cloning repository..."
            cd /home/ec2-user
            git clone https://github.com/AWS-daml/l1-activity-automation.git
          else
            echo "ðŸ”„ Updating repository..."
            cd /home/ec2-user/l1-activity-automation
            git pull origin master
          fi
          
          cd /home/ec2-user/l1-activity-automation
          
          # Backend setup
          echo "ðŸ Setting up Python backend..."
          cd backend
          
          # Create virtual environment if it doesn't exist
          if [ ! -d "venv" ]; then
            python3 -m venv venv
          fi
          
          # Activate virtual environment and install dependencies
          source venv/bin/activate
          pip install -r requirements.txt
          
          # Stop existing backend process
          pm2 delete l1-backend 2>/dev/null || true
          
          # Start backend with PM2
          pm2 start app.py --name l1-backend --interpreter python3
          
          # Frontend setup
          echo "âš›ï¸ Setting up React frontend..."
          cd ../frontend
          
          # Install dependencies and build
          npm install
          npm run build
          
          # Configure Nginx
          echo "ðŸŒ Configuring Nginx..."
          sudo mkdir -p /var/www/html
          sudo cp -r build/* /var/www/html/
          
          # Create Nginx configuration
          sudo tee /etc/nginx/conf.d/l1-automation.conf > /dev/null <<EOF
          server {
              listen 80;
              server_name _;
              
              # Frontend
              location / {
                  root /var/www/html;
                  index index.html;
                  try_files \$uri \$uri/ /index.html;
              }
              
              # Backend API
              location /api/ {
                  proxy_pass http://localhost:5000/;
                  proxy_set_header Host \$host;
                  proxy_set_header X-Real-IP \$remote_addr;
                  proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;
                  proxy_set_header X-Forwarded-Proto \$scheme;
              }
          }
          EOF
          
          # Start and enable services
          sudo systemctl enable nginx
          sudo systemctl restart nginx
          
          # Save PM2 processes
          pm2 save
          pm2 startup systemd -u ec2-user --hp /home/ec2-user
          
          # Set permissions
          sudo chown -R ec2-user:ec2-user /home/ec2-user/l1-activity-automation
          
          echo "âœ… L1 Activity Automation deployed successfully!"
          echo "ðŸŒ Frontend: http://$(curl -s http://checkip.amazonaws.com)"
          echo "ðŸ”§ Backend API: http://$(curl -s http://checkip.amazonaws.com)/api"
          echo "ðŸ“Š PM2 Status:"
          pm2 list
