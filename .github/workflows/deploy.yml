name: L1 Activity Automation CI/CD

on:
  push:
    branches: [ master ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: production
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Deploy to EC2
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ec2-user
        key: ${{ secrets.EC2_SSH_KEY }}
        port: 22
        script: |
          set -e
          echo "ðŸš€ Starting L1 Activity Automation Deployment..."
          
          # Update system and install packages (only if needed)
          if ! command -v node &> /dev/null; then
            sudo yum update -y
            sudo yum install -y nodejs npm python3 python3-pip git nginx
            sudo npm install -g pm2
          fi
          
          # Clone or update repository
          if [ ! -d "/home/ec2-user/l1-activity-automation" ]; then
            echo "ðŸ“¦ Cloning repository..."
            cd /home/ec2-user
            git clone https://github.com/AWS-daml/l1-activity-automation.git
          else
            echo "ðŸ”„ Updating repository..."
            cd /home/ec2-user/l1-activity-automation
            git pull origin master
          fi
          
          cd /home/ec2-user/l1-activity-automation
          
          # Backend setup
          echo "ðŸ Setting up Python backend..."
          cd backend
          
          # Create and activate virtual environment
          python3 -m venv venv
          source venv/bin/activate
          pip install -r requirements.txt
          
          # Stop and start backend with PM2
          pm2 delete l1-backend 2>/dev/null || true
          pm2 start app.py --name l1-backend --interpreter python3
          
          # Frontend setup
          echo "âš›ï¸ Setting up React frontend..."
          cd ../frontend
          npm install
          npm run build
          
          # Configure Nginx
          echo "ðŸŒ Configuring Nginx..."
          sudo mkdir -p /var/www/html
          sudo cp -r build/* /var/www/html/
          
          # Simple Nginx config
          sudo tee /etc/nginx/conf.d/l1-automation.conf > /dev/null <<'EOF'
          server {
              listen 80;
              server_name _;
              
              location / {
                  root /var/www/html;
                  index index.html;
                  try_files $uri $uri/ /index.html;
              }
              
              location /api/ {
                  proxy_pass http://localhost:5000/;
                  proxy_set_header Host $host;
                  proxy_set_header X-Real-IP $remote_addr;
              }
          }
          EOF
          
          # Start services
          sudo systemctl enable nginx
          sudo systemctl restart nginx
          
          # Save PM2 processes (simple version)
          pm2 save
          
          echo "âœ… L1 Activity Automation deployed successfully!"
          echo "ðŸŒ Frontend: http://$(curl -s http://checkip.amazonaws.com)"
          echo "ðŸ”§ Backend: Running on PM2"
          pm2 list
          sudo systemctl status nginx --no-pager
